### Regridding ERA5 forcing data to the WRF-Hydro domain

#### Software and input data

- NCL
- Input file requirements:

    1. A geogrid file (geo_em.d03.nc) for your 'destination' domain (WRF-Hydro grid)
    
    2. ERA5 data (this contains the 'source' domain or grid)

    The ERA5 data fields used by WRF-Hydro / the regridding scripts are:

        "lat"   - latitude
        "lon"   - longitude
        "mtpr"  - surface air pressure
        "2t"   - surface air temperature
        "10u"   - 10 metre U wind speed
        "10v"   - 10 metre V wind speed
        "sh_2m"   - specific humidity
        "Rainf_f_tavg"  - precipitation flux
        "ssrd" - downward shortwave radiation flux
        "strd" - downward longwave radiation flux

**Step 1: Setup the ERA5 forcing directory**

```bash
mkdir -p $wrfhome/input/era5
cd $wrfhome/input/era5
mkdir input_files
cp /scratch/WRF_HYDRO_SHARED/ERA5/NMA_training/* input_files/
cp /scratch/WRF_HYDRO_SHARED/ERA5/*.ncl .
cp /scratch/WRF_HYDRO_SHARED/ERA5/geo_em.d03.nc .
```

**REGRIDDING** is the process to utilize ESMF (Earth Systme Model Framework) regridding tools within the NCL programming language is a 2 step process.

The steps are as follows:

1. Create regridding 'weight' files required by the ESMF regridders. The weight
   files are netCDF files which specify interpolation weights between the source
   coordinate data grids (src) and destination coordinate data (dst) grids. The
   weight file is generated by running the 'GLDAS2WRFHydro_generate_weights.ncl'
   script. Users will need to provide the source and destination grid filenames
   as arguments to the script.


2. The second step is to then do the regridding using the
   'GLDAS2WRFHydro_regrid.ncl' script which ingests both source data and the
   relevant weight file as inputs and then outputs regridded data on the
   destination grid
   
   Thus the 2 scripts used to do the regridding are:
   
     - GLDAS2WRFHydro_generate_weights.ncl
     - GLDAS2WRFHydro_regrid.ncl
     

**Step 2: check the input fields**
```bash
ncdump $wrfhome/input/era5/era5_1H.2006.08.01.00.nc
ncview $wrfhome/input/era5/era5_1H.2006.08.01.00.nc
```

**Step 3 Running 'GLDAS2WRFHydro_generate_weights.ncl'**

```bash
ncl 'interp_opt="bilinear"' 'srcGridName="input_files/era5_1H.2006.08.01.00.nc"' 'dstGridName="geo_em.d03.nc"' GLDAS2WRFHydro_generate_weights.ncl

 - interp_opt  = conserve / bilinear
 - srcGridName = name of file that contains source grid
 - dstGridName = name of file that contains the destination (WRF-Hydro) grid

```

**Step 4 Running 'GLDAS2WRFHydro_regrid.ncl'**

    1. This script will use the regridding weight files created by the 'GLDAS2WRFHydro_generate_weights.ncl' script. Therefore, do not change the names of those files or else this script will not be able to find them.
    2. The source data to be regridded (ERA5 data with the default filenames) needs to be placed in a local directory called 'input_files/'
    3. The output data created from this script will be placed in a local directory called 'output_files/'. If this directory is not present the script will create it.

```bash
ncl 'srcFileName="era5_1H.2006.08*.nc"' 'dstGridName="geo_em.d03.nc"' GLDAS2WRFHydro_regrid.ncl
 
- srcFileName = filename pattern of the souce ERA5 files.
- dstGridName = name of file that contains the destination (WRF-Hydro) grid

```
